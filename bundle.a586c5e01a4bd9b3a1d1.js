(()=>{"use strict";class t{constructor(t){this.$el="string"==typeof t?document.querySelector(t):t}html(t){return"string"==typeof t?(this.$el.innerHTML=t,this):this.$el.outerHTML.trim()}text(t){return"string"==typeof t?(this.$el.textContent=t,this):"input"===this.$el.tagName.toLowerCase()?this.$el.value.trim():this.$el.textContent.trim()}append(e){return e instanceof t&&(e=e.$el),Element.prototype.append?this.$el.append(e):this.$el.appendChild(e),this}clear(){return this.html(""),this}on(t,e){this.$el.addEventListener(t,e)}off(t,e){this.$el.removeEventListener(t,e)}get data(){return this.$el.dataset}closest(t){return e(this.$el.closest(t))}getCoords(){return this.$el.getBoundingClientRect()}id(t){if(t){const t=this.id().split(":");return{row:+t[0],col:+t[1]}}return this.data.id}find(t){return e(this.$el.querySelector(t))}findAllSelectors(t){return this.$el.querySelectorAll(t)}focus(){return this.$el.focus(),this}addClass(t){return this.$el.classList.add(t),this}removeClass(t){return this.$el.classList.remove(t),this}css(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.keys(t).forEach((e=>this.$el.style[e]=t[e]))}getStyles(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).reduce(((t,e)=>(t[e]=this.$el.style[e],t)),{})}}function e(e){return new t(e)}e.create=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const r=document.createElement(t);return n&&r.classList.add(n),e(r)};class n{constructor(){this.listeners={}}emit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return!!Array.isArray(this.listeners[t])&&(this.listeners[t].forEach((t=>{t(...n)})),!0)}subscribe(t,e){return this.listeners[t]=this.listeners[t]||[],this.listeners[t].push(e),()=>{this.listeners[t]=this.listeners[t].filter((t=>t!==e))}}}function r(t,e){return t>e&&([e,t]=[t,e]),new Array(e-t+1).fill("").map(((e,n)=>t+n))}function s(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)return JSON.parse(localStorage.getItem(t));localStorage.setItem(t,JSON.stringify(e))}class i{constructor(t){this.store=t,this.sub=null,this.prevState={}}subscribeComponent(t){this.prevState=this.store.getState(),this.sub=this.store.subscribe((e=>{Object.keys(e).forEach((n=>{var r,s;r=this.prevState[n],s=e[n],("object"==typeof r&&"object"==typeof s?JSON.stringify(r)===JSON.stringify(s):r===s)||t.forEach((t=>{if(t.isWatching(n)){const r={[n]:e[n]};t.storeChanged(r)}}))})),this.prevState=this.store.getState()}))}unsubscribeComponent(){this.sub.unsubscribe()}}class o{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!t)throw new Error("No $root provided for DomListener");this.$root=t,this.listeners=e}initDomListeners(){this.listeners.forEach((t=>{const e=a(t);if(!this[e]){const t=this.name||"";throw new Error("Method ".concat(e," is not implemented in ").concat(t," component"))}this[e]=this[e].bind(this),this.$root.on(t,this[e])}))}removeDomListeners(){this.listeners.forEach((t=>{const e=a(t);this.$root.off(t,this[e])}))}}function a(t){return"on"+("string"!=typeof(e=t)?"":e.charAt(0).toLocaleUpperCase()+e.slice(1));var e}class c extends o{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e.listeners),this.name=e.name||"",this.emitter=e.emitter,this.subscribe=e.subscribe||[],this.unsubscribers=[],this.store=e.store,this.prepare()}prepare(){}toHTML(){return""}$emit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.emitter.emit(t,...n)}$on(t,e){const n=this.emitter.subscribe(t,e);this.unsubscribers.push(n)}$dispatch(t){this.store.dispatch(t)}storeChanged(){}isWatching(t){return this.subscribe.includes(t)}init(){this.initDomListeners()}destroy(){this.removeDomListeners(),this.unsubscribers.forEach((t=>t()))}}class l extends c{constructor(t,e){super(t,{name:"Formula",listeners:["input","keydown"],subscribe:["currentText"],...e})}toHTML(){return'\n      <div class="info">fx</div>\n      <div \n        id="formula" \n        class="input" \n        contenteditable \n        spellcheck="false"\n      ></div>\n    '}init(){super.init(),this.$formula=this.$root.find("#formula"),this.$on("table:select",(t=>{this.$formula.text(t.text())}))}storeChanged(t){let{currentText:e}=t;this.$formula.text(e)}onKeydown(t){["Enter","Tab"].includes(t.key)&&(t.preventDefault(),this.$emit("formula:done"))}onInput(t){this.$emit("formula:input",e(t.target).text())}}!function(t,e,n){var r;(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(e))?r:r+"")in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(l,"className","excel__formula");const u="TABLE_RESIZE",h="CHANGE_TEXT",d="APPLY_STYLE",p="CHANGE_STYLES",f="CHANGE_TITLE",m={textAlign:"left",fontWeight:"normal",textDecoration:"none",fontStyle:"normal"},v="Новая таблица !";class b extends c{constructor(t,e){super(t,{name:"Header",listeners:["input"],...e})}onInput(t){const n=e(t.target);var r;this.$dispatch((r=n.text(),{type:f,data:r}))}toHTML(){const t=this.store.getState().title||v;return'\n    <input class="input" type="text" value="'.concat(t,'"/>\n    <div>\n      <div class="button">\n        <i class="material-icons">delete</i>\n      </div>\n      <div class="button">\n        <i class="material-icons">exit_to_app</i>\n      </div>\n    </div>\n    ')}}!function(t,e,n){var r;(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(e))?r:r+"")in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(b,"className","excel__header");const y={A:65,Z:90},g=120,S=24;function w(t,e){return(t[e]||g)+"px"}function x(t,e){return function(n,r){const s="".concat(e,":").concat(r),i=w(t.colState,r),o=t.dataState[s]||"",a=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(t).map((e=>{return"".concat((n=e,n.replace(/([A-Z])/g,(t=>"-".concat(t[0].toLowerCase())))),": ").concat(t[e]);var n})).join("; ")}({...m,...t.stylesState[s]});return'\n      <div \n        class="cell" \n        contenteditable \n        data-col="'.concat(r,'"\n        data-type="cell"\n        data-id="').concat(s,'"\n        style="').concat(a,"; width: ").concat(i,'"\n      >\n        ').concat(o,"\n      </div>")}}function $(t){let{col:e,index:n,width:r}=t;return'\n    <div \n    class="column" \n    data-type="resizable" \n    data-col="'.concat(n,'"\n    style="width: ').concat(r,'"\n    >\n      ').concat(e,'\n      <div class="col-resize" data-resize="col"></div>\n    </div>\n    ')}function E(t,e,n){const r=t?'<div class="row-resize" data-resize="row"></div>':"",s=function(t,e){return(t[e]||S)+"px"}(n,t);return'\n    <div \n      class="row" \n      data-type="resizable" \n      data-row="'.concat(t,'"\n      style="height: ').concat(s,'"\n    >\n     <div class="row-info">\n       ').concat(t||"","\n       ").concat(r,'\n     </div>\n       <div class="row-data">').concat(e,"</div>\n    </div>\n    ")}function A(t,e){return String.fromCharCode(y.A+e)}class T{constructor(){this.group=[],this.current=null}get selectedIds(){return this.group.map((t=>t.id()))}select(t){this.clear(),t.focus().addClass(T.className),this.group.push(t),this.current=t}clear(){this.group.forEach((t=>t.removeClass(T.className))),this.group=[]}selectGroup(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.clear(),this.group=t,this.group.forEach((t=>t.addClass(T.className)))}applyStyle(t){this.group.forEach((e=>{e.css(t)}))}}!function(t,e,n){var r;(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(e))?r:r+"")in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(T,"className","selected");class C extends c{constructor(t,e){super(t,{name:"Table",listeners:["mousedown","keydown","input"],...e})}prepare(){this.selection=new T}toHTML(){return function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=y.Z-y.A+1,r=[],s=new Array(n).fill("").map(A).map(function(t){return function(e,n){return{col:e,index:n,width:w(t.colState,n)}}}(e)).map($).join("");r.push(E(null,s,{}));for(let s=0;s<t;s++){const t=new Array(n).fill("").map(x(e,s)).join("");r.push(E(s+1,t,e.rowState))}return r.join("")}(10,this.store.getState())}selectCell(t){this.selection.select(t),this.$emit("table:select",t);const e=t.getStyles(Object.keys(m));this.$dispatch({type:p,data:e})}init(){super.init();const t=this.$root.find('[data-id="0:0"]');this.selectCell(t),this.$on("formula:input",(t=>{this.selection.current.text(t),this.updateTextInStore(t)})),this.$on("formula:done",(()=>{this.selection.current.focus()})),this.$on("toolbar:applyStyle",(t=>{var e;this.selection.applyStyle(t),this.$dispatch((e={value:t,ids:this.selection.selectedIds},{type:d,data:e}))}))}async resizeTable(t){try{const n=await function(t,n){return new Promise((r=>{const s=e(n.target),i=s.closest('[data-type="resizable"]'),o=i.getCoords(),a=s.data.resize,c="col"===a?"bottom":"right";let l;s.css({opacity:1,[c]:"-3000px"}),document.onmousemove=t=>{if("col"===a){const e=t.pageX-o.right;l=o.width+e;const n=40;l=Math.max(l,n);const r=o.width-n,i=Math.min(-e,r);s.css({right:"".concat(i,"px")})}else{const e=t.pageY-o.bottom;l=o.height+e;const n=20;l=Math.max(l,n);const r=o.height-n,i=Math.min(-e,r);s.css({bottom:"".concat(i,"px")})}},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null,"col"===a?(i.css({width:l+"px"}),t.findAllSelectors('[data-col="'.concat(i.data.col,'"]')).forEach((t=>t.style.width=l+"px"))):i.css({height:l+"px"}),r({value:l,type:a,id:i.data[a]}),s.css({opacity:0,right:0,bottom:0})}}))}(this.$root,t);this.$dispatch(function(t){return{type:u,data:t}}(n))}catch(t){console.warn(t.message)}}onMousedown(t){if(function(t){return t.target.dataset.resize}(t))this.resizeTable(t);else if(function(t){return"cell"===t.target.dataset.type}(t)){const n=e(t.target);if(t.shiftKey){const t=function(t,e){const n=t.id(!0),s=e.id(!0),i=r(s.col,n.col),o=r(s.row,n.row);return i.reduce(((t,e)=>(o.forEach((n=>t.push("".concat(n,":").concat(e)))),t)),[])}(n,this.selection.current).map((t=>this.$root.find('[data-id="'.concat(t,'"]'))));this.selection.selectGroup(t)}else this.selectCell(n)}}onKeydown(t){const{key:e,shiftKey:n}=t;if(["Enter","Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e)&&!n){t.preventDefault();const n=this.selection.current.id(!0),r=this.$root.find(function(t,e){let{row:n,col:r}=e;const s=y.Z-y.A;switch(t){case"Enter":case"ArrowDown":n=n+1>9?9:n+1;break;case"Tab":case"ArrowRight":r=r+1>s?25:r+1;break;case"ArrowLeft":r=r-1<0?0:r-1;break;case"ArrowUp":n=n-1<0?0:n-1}return'[data-id="'.concat(n,":").concat(r,'"]')}(e,n));this.selectCell(r)}}updateTextInStore(t){var e;this.$dispatch((e={id:this.selection.current.id(),value:t},{type:h,data:e}))}onInput(t){this.updateTextInStore(e(t.target).text())}}function L(t){const e='\n    data-type="button"\n    data-value=\''.concat(JSON.stringify(t.value),"'\n  ");return'\n    <div class="button '.concat(t.active?"active":"",'" ').concat(e,'>\n      <i \n      class="material-icons" \n      ').concat(e,"\n      >").concat(t.icon,"</i>\n    </div> ")}!function(t,e,n){var r;(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(e))?r:r+"")in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(C,"className","excel__table");class _ extends c{constructor(){super(...arguments)}get template(){return JSON.stringify(this.state,null,2)}initState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.state={...t}}setState(t){this.state={...this.state,...t},this.$root.html(this.template)}}class j extends _{constructor(t,e){super(t,{name:"Toolbar",listeners:["click"],subscribe:["currentStyles"],...e})}prepare(){this.initState(m)}storeChanged(t){this.setState(t.currentStyles)}get template(){return[{icon:"format_align_left",active:"left"===(t=this.state).textAlign,value:{textAlign:"left"}},{icon:"format_align_center",active:"center"===t.textAlign,value:{textAlign:"center"}},{icon:"format_align_right",active:"right"===t.textAlign,value:{textAlign:"right"}},{icon:"format_bold",active:"bold"===t.fontWeight,value:{fontWeight:"bold"===t.fontWeight?"normal":"bold"}},{icon:"format_italic",active:"italic"===t.fontStyle,value:{fontStyle:"italic"===t.fontStyle?"normal":"italic"}},{icon:"format_underlined",active:"underline"===t.textDecoration,value:{textDecoration:"underline"===t.textDecoration?"none":"underline"}}].map(L).join("");var t}toHTML(){return this.template}onClick(t){const n=e(t.target);if("button"===n.data.type){const t=JSON.parse(n.data.value);this.$emit("toolbar:applyStyle",t)}}}function N(t,e,n){const r=e[t]||{};return r[n.data.id]=n.data.value,r}!function(t,e,n){var r;(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(e))?r:r+"")in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(j,"className","excel__toolbar");const O="excel-state",P={title:v,colState:{},rowState:{},dataState:{},stylesState:{},currentText:"",currentStyles:m};var k;const I=function(t){let e=t({...arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}},{type:"__INIT__"}),n=[];return{subscribe:t=>(n.push(t),{unsubscribe(){n=n.filter((e=>e!==t))}}),dispatch(r){e=t(e,r),n.forEach((t=>t(e)))},getState:()=>JSON.parse(JSON.stringify(e))}}((function(t,e){let n,r;switch(e.type){case u:return n="col"===e.data.type?"colState":"rowState",{...t,[n]:N(n,t,e)};case h:return n="dataState",{...t,currentText:e.data.value,[n]:N(n,t,e)};case p:return{...t,currentStyles:e.data};case d:return n="stylesState",r=t[n]||{},e.data.ids.forEach((t=>{r[t]={...r[t],...e.data.value}})),{...t,[n]:r,currentStyles:{...t.currentStyles,...e.data.value}};case f:return{...t,title:e.data};default:return t}}),s(O)?(k=s(O),{...k,currentStyles:m,currentText:""}):P);I.subscribe((t=>{s(O,t)})),new class{constructor(t,r){this.$el=e(t),this.components=r.components||[],this.emitter=new n,this.store=r.store,this.subscriber=new i(this.store)}getRoot(){const t=e.create("div","excel"),n={emitter:this.emitter,store:this.store};return this.components=this.components.map((r=>{const s=e.create("div",r.className),i=new r(s,n);return s.html(i.toHTML()),t.append(s),i})),t}render(){this.$el.append(this.getRoot()),this.subscriber.subscribeComponent(this.components),this.components.forEach((t=>t.init()))}destroy(){this.subscriber.unsubscribeComponent(),this.components.forEach((t=>t.destroy()))}}("#app",{components:[b,j,l,C],store:I}).render()})();